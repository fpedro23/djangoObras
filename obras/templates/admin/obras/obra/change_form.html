{% extends "admin/base_site.html" %}
{% load i18n admin_urls admin_static admin_modify%}

{% block extrahead %}{{ block.super }}
    <script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>
     <script type="text/javascript" src="{% static 'assets/js/ajax-movimientos.js' %}"></script>
    <script type="text/javascript" src="{% static 'assets/js/ajax-estados-municipios.js' %}"></script>
     <link href="{% static "css/formas.css" %}" rel="stylesheet">
        <link href="{% static "css/widgets.css" %}" rel="stylesheet">
     <link href="{% static "assets/bootstrap/css/bootstrap-datepicker3.min.css"%}" rel="stylesheet">
    <script type="text/javascript" src="{% static 'assets/bootstrap/js/bootstrap.file-input.js' %}"></script>
     <script type="text/javascript" src="{% static 'assets/bootstrap/js/bootstrap.js' %}"></script>
    {{ media }}
<script>
function elimCancelada() {
        {% if not change %}
            var x = document.getElementById("id_tipoObra");
            x.remove(4);
        {% endif %}

}
</script>

    <script type="text/javascript">
(

        function($) {
var $tt = jQuery.noConflict();

function $_GET(param)
{
/* Obtener la url completa */
url = document.URL;
/* Buscar a partir del signo de interrogación ? */
url = String(url.match(/\?+.+/));
/* limpiar la cadena quitándole el signo ? */
url = url.replace("?", "");
/* Crear un array con parametro=valor */
url = url.split("&");

/*
Recorrer el array url
obtener el valor y dividirlo en dos partes a través del signo =
0 = parametro
1 = valor
Si el parámetro existe devolver su valor
*/
x = 0;
while (x < url.length)
{
p = url[x].split("=");
if (p[0] == param)
{
return decodeURIComponent(p[1]);
}
x++;
}



}


    $(document).ready(function($) {
        elimCancelada();


        $("tr input.action-select").actions();
        if ($_GET("m")==1 || (window.location.href).search('add')<0) {
            $("#walta").hide();
            $("#wmod").show();
            $("#buscar").show();
            $("#buscarICO").show();
            $(".imprimirBTN").show();

        }
        else {
            $("#walta").show();
            $("#wmod").hide();
             $("#buscar").hide();
            $("#buscarICO").hide();
            //$(".imprimirBTN").hide();

        }



            $tt('#imgerr1').tooltip({html:true});$tt('#imgerr2').tooltip({html:true});$tt('#imgerr3').tooltip({html:true});
            $tt('#imgerr4').tooltip({html:true});$tt('#imgerr5').tooltip({html:true});$tt('#imgerr6').tooltip({html:true});
            $tt('#imgerr7').tooltip({html:true});$tt('#imgerr8').tooltip({html:true});$tt('#imgerr9').tooltip({html:true});$tt('#imgerr10').tooltip({html:true});
            $tt('#imgerr11').tooltip({html:true});$tt('#imgerr12').tooltip({html:true});$tt('#imgerr13').tooltip({html:true});$tt('#imgerr14').tooltip({html:true});
            $tt('#imgerr15').tooltip({html:true});$tt('#imgerr16').tooltip({html:true});$tt('#imgerr17').tooltip({html:true});$tt('#imgerr18').tooltip({html:true});
            $tt('#imgerr19').tooltip({html:true});$tt('#imgerr20').tooltip({html:true});$tt('#imgerr21').tooltip({html:true});$tt('#imgerr22').tooltip({html:true});

            $tt('#imgerr23').tooltip({html:true});$tt('#imgerr24').tooltip({html:true});$tt('#imgerr25').tooltip({html:true});$tt('#imgerr26').tooltip({html:true});
            $tt('#imgerr27').tooltip({html:true});$tt('#imgerr28').tooltip({html:true});$tt('#imgerr29').tooltip({html:true});$tt('#imgerr30').tooltip({html:true});

           $tt(document).on('change','#id_detalleinversion_set-0-monto',calculaTotal);
           $tt(document).on('change','#id_detalleinversion_set-1-monto',calculaTotal);
           $tt(document).on('change','#id_detalleinversion_set-2-monto',calculaTotal);
           $tt(document).on('change','#id_detalleinversion_set-3-monto',calculaTotal);
           $tt(document).on('change','#id_detalleinversion_set-4-monto',calculaTotal);
           $tt(document).on('change','#id_detalleinversion_set-5-monto',calculaTotal);
           $tt(document).on('change','#id_detalleinversion_set-6-monto',calculaTotal);
           $tt(document).on('change','#id_detalleinversion_set-__prefix__-monto',calculaTotal);

            $tt('#id_inversionTotal').on('click',calculaTotal);
            $tt('#id_inversionTotal').on('change',calculaTotal);

           $tt(document).on('click','a.inline-deletelink',calculaTotal);

           $tt(document).on('keyup','input[type=text]',function(){
               $j(this).val($j(this).val().toUpperCase());
           });
    });

    function calculaTotal(){
        var TotInv=Number(0);
        var sub0,sub1,sub2,sub3,sub4,sub5,sub6,sub7;

        if (isNaN($tt('#id_detalleinversion_set-__prefix__-monto').val())) {
            sub0=Number(0);
        }else { sub0= Number($tt('#id_detalleinversion_set-__prefix__-monto').val());}

        if (isNaN($tt('#id_detalleinversion_set-0-monto').val())) {
            sub1=Number(0);
        }else { sub1= Number($tt('#id_detalleinversion_set-0-monto').val());}

         if (isNaN($tt('#id_detalleinversion_set-1-monto').val())) {
            sub2=Number(0);
        }else { sub2= Number($tt('#id_detalleinversion_set-1-monto').val());}

         if (isNaN($tt('#id_detalleinversion_set-2-monto').val())) {
            sub3=Number(0);
        }else { sub3= Number($tt('#id_detalleinversion_set-2-monto').val());}

         if (isNaN($tt('#id_detalleinversion_set-3-monto').val())) {
            sub4=Number(0);
        }else { sub4= Number($tt('#id_detalleinversion_set-3-monto').val());}

         if (isNaN($tt('#id_detalleinversion_set-4-monto').val())) {
            sub5=Number(0);
        }else { sub5= Number($tt('#id_detalleinversion_set-4-monto').val());}

         if (isNaN($tt('#id_detalleinversion_set-5-monto').val())) {
            sub6=Number(0);
        }else { sub6= Number($tt('#id_detalleinversion_set-5-monto').val());}

         if (isNaN($tt('#id_detalleinversion_set-6-monto').val())) {
            sub7=Number(0);
        }else { sub7= Number($tt('#id_detalleinversion_set-6-monto').val());}

        //alert(sub0+sub1+sub2+sub3+sub4+sub5+sub6+sub7);
        TotInv=sub0+sub1+sub2+sub3+sub4+sub5+sub6+sub7;
        if (TotInv > 0){
             $tt('#id_inversionTotal').val(TotInv);
        }
        else
        {
            $tt('#id_inversionTotal').val('');
            $j.magnificPopup.open({
                                                items: {
                                                    src:  '<div id="test-modal" class="alertaVENTANA" style="top:0px; left: 450px;">'
                                                          + '<div class="textoALERTA">'
                                                          +  'El monto de Inversión Total debe ser diferente a 0.'
                                                          + '</div>'
                                                          + '<a class="popup-modal-dismiss" href="#"><div class="aceptarBTN" style="left:150px;"> </div></a>'
                                                          + '</div>'
                                                },
                                                type: 'inline',
                                                preloader: true,
                                                modal: true
                                            });

                                            $j(document).on('click', '.popup-modal-dismiss', function (e) {
                                                e.preventDefault();
                                                $j.magnificPopup.close();
                                            });
        }

    }
})(django.jQuery);
</script>

{% endblock %}

{% block extrastyle %}{{ block.super }}
<style>

</style>
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form{% endblock %}

{% if not is_popup %}
    {% block breadcrumbs %}
    {% endblock %}
{% endif %}

{% block content %}

    <div id="regresarBTN" onclick="window.history.go(-1);">
   </div>

  <div id="welcome">

           <span id="walta" hidden="true">Registro de Obra</span>

            <span id="wmod" hidden="true">Modificación de Obra</span>



  </div>

     <div id="buscar" hidden="true">
     <input type="hidden" id="tok" value="{% csrf_token %}">
     <input class="buscar" type="text" name="idobra" value="" id="idobra">
  </div>

  <div id="buscarICO" hidden="true">
  </div>

   <div class="historialBTN" onclick="location.href='/admin/obras/obra/'"></div>
   <div class="imprimirBTN" id="imprimirBTN" ></div>

        {% block object-tools %}
            {% if change %}{% if not is_popup %}
                <ul class="object-tools">
                    {% block object-tools-items %}
                        {% if has_absolute_url %}
                            <li><a href="{{ absolute_url }}" class="viewsitelink">{% trans "View on site" %}</a></li>
                        {% endif %}
                    {% endblock %}
                </ul>
            {% endif %}{% endif %}
        {% endblock %}
        <form {% if has_file_field %}enctype="multipart/form-data" {% endif %}action="{{ form_url }}" method="post"
              id="{{ opts.model_name }}_form" novalidate>{% csrf_token %}{% block form_top %}{% endblock %}
            {% if errors %}
                <div class="msggen">

                {% if adminform.form.non_field_errors|length == 1 %} * Favor de verificar los siguientes datos {% else %}
                        * Favor de verificar los siguientes datos {% endif %} {{ adminform.form.non_field_errors }}
                </div>
            {% endif %}
            <div>
                {% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1"/>{% endif %}
                {% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}"/>{% endif %}
                {% if save_on_top %}{% block submit_buttons_top %}{% submit_row %}{% endblock %}{% endif %}

                {% block field_sets %}
                    {% for fieldset in adminform %}
                        {% include "admin/obras/obra/fieldset.html" %}
                    {% endfor %}
                {% endblock %}


                {% block after_field_sets %}{% endblock %}

                {% block inline_field_sets %}

                {% endblock %}

                {% block after_related_objects %}{% endblock %}

                {% block submit_buttons_bottom %}{% endblock %}
            {% if adminform and add %}
    <script type="text/javascript">
        (function($) {
            $(document).ready(function() {
                $('form#{{ opts.model_name }}_form :input:visible:enabled:first').focus()
            });
        })(django.jQuery);
    </script>
{% endif %}
                {% block admin_change_form_document_ready %}


                    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>


                           <script src="{% static "assets/bootstrap/js/bootstrap-datepicker.js"%}"></script>


                   <script type="text/javascript">

                        var $dp = jQuery.noConflict();

                        //FECHA INICIO
                        $dp('#id_fechaInicio').datepicker({
                            autoclose: true  ,
                            setEndDate: $dp('#id_fechaTermino').val()
                            }).on('changeDate', function (selected) {
                                  var startDate = new Date(selected.date.valueOf());
                                  var endDate = $dp('#id_fechaTermino').val();
                                  var NDDate =   new Date($dp('#id_fechaTermino').datepicker("getDate"));
                                  var today = new Date();
                                  if (endDate != "") {
                                      if (startDate > NDDate) {
                                          //alert("La fecha de Inicio debe ser anterior a la fecha de Término");
                                          $j.magnificPopup.open({
                                                items: {
                                                    src:  '<div id="test-modal" class="alertaVENTANA" style="top:0px; left: 450px;">'
                                                          + '<div class="textoALERTA">'
                                                          +  'La fecha de Inicio debe ser anterior a la fecha de Término.'
                                                          + '</div>'
                                                          + '<a class="popup-modal-dismiss" href="#"><div class="aceptarBTN" style="left:150px;"> </div></a>'
                                                          + '</div>'
                                                },
                                                type: 'inline',
                                                preloader: true,
                                                modal: true
                                            });

                                            $j(document).on('click', '.popup-modal-dismiss', function (e) {
                                                e.preventDefault();
                                                $j.magnificPopup.close();
                                            });

                                          $dp('#id_fechaInicio').datepicker('setEndDate', endDate);
                                          $dp('#id_fechaInicio').SetDate(endDate);
                                      }
                                      else
                                    { $dp('#id_fechaTermino').datepicker('setStartDate', startDate); }

                                      //Debe ser "en proceso" si tiene una fecha de inicio anterior a hoy; y una fecha de término posterior a hoy.
                                    if ((startDate < today) && $j('select#id_tipoObra').val()!='2') {
                                        $j('select#id_tipoObra').val('---------');
                                        $j.magnificPopup.open({
                                            items: {
                                                src: '<div id="test-modal" class="alertaVENTANA" style="top:0px; left: 450px;">'
                                                + '<div class="textoALERTA">'
                                                + 'El Status de la obra debe ser en PROCESO y el Avance mayor a 0'
                                                + '</div>'
                                                + '<a class="popup-modal-dismiss" href="#"><div class="aceptarBTN" style="left:150px;"> </div></a>'
                                                + '</div>'
                                            },
                                            type: 'inline',
                                            preloader: true,
                                            modal: true
                                        });

                                        $j(document).on('click', '.popup-modal-dismiss', function (e) {
                                            e.preventDefault();
                                            $j.magnificPopup.close();
                                        });
                                    }
                                  }
                                    else
                                    { $dp('#id_fechaTermino').datepicker('setStartDate', startDate); }
                                    //fecha de inicio mayor al dia de hoy status debe ser en proyecto

                                    if ((startDate > today) && $j('select#id_tipoObra').val()!='1' ){
                                        $j('select#id_tipoObra').val('---------');
                                        $j.magnificPopup.open({
                                                items: {
                                                    src:  '<div id="test-modal" class="alertaVENTANA" style="top:0px; left: 450px;">'
                                                          + '<div class="textoALERTA">'
                                                          +  'El Status de la obra debe ser PROYECTADA y el Avance igual a 0'
                                                          + '</div>'
                                                          + '<a class="popup-modal-dismiss" href="#"><div class="aceptarBTN" style="left:150px;"> </div></a>'
                                                          + '</div>'
                                                },
                                                type: 'inline',
                                                preloader: true,
                                                modal: true
                                            });

                                            $j(document).on('click', '.popup-modal-dismiss', function (e) {
                                                e.preventDefault();
                                                $j.magnificPopup.close();
                                            });
                                    }

                                         //Debe ser "en proceso" si tiene una fecha de inicio anterior a hoy; y una fecha de término posterior a hoy.
                                    if ((startDate < today) && $j('select#id_tipoObra').val()!='2') {
                                        $j('select#id_tipoObra').val('---------');
                                        $j.magnificPopup.open({
                                            items: {
                                                src: '<div id="test-modal" class="alertaVENTANA" style="top:0px; left: 450px;">'
                                                + '<div class="textoALERTA">'
                                                + 'El Status de la obra debe ser en PROCESO y el Avance mayor a 0'
                                                + '</div>'
                                                + '<a class="popup-modal-dismiss" href="#"><div class="aceptarBTN" style="left:150px;"> </div></a>'
                                                + '</div>'
                                            },
                                            type: 'inline',
                                            preloader: true,
                                            modal: true
                                        });

                                        $j(document).on('click', '.popup-modal-dismiss', function (e) {
                                            e.preventDefault();
                                            $j.magnificPopup.close();
                                        });
                                    }

                               }).on('clearDate', function (selected) {
                                     $dp('#id_fechaTermino').datepicker('setStartDate', null);
                                  });
                        //FECHA TERMINO
                        $dp('#id_fechaTermino').datepicker({
                            autoclose: true          ,
                            setStartDate: $dp('#id_fechaInicio').val()
                        }).on('changeDate', function (selected) {
                            var endDate = new Date(selected.date.valueOf());
                            var startDate = $dp('#id_fechaInicio').val();
                            var STDate =   new Date($dp('#id_fechaInicio').datepicker("getDate"));
                            var today = new Date();
                              if (startDate != "") {
                                  if (STDate > endDate) {
                                      //alert("La fecha de Término debe ser posterior a la fecha de Inicio");

                                      $j.magnificPopup.open({
                                                items: {
                                                    src:  '<div id="test-modal" class="alertaVENTANA" style="top:0px; left: 450px;">'
                                                          + '<div class="textoALERTA">'
                                                          +  'La fecha de Término debe ser posterior a la fecha de Inicio.'
                                                          + '</div>'
                                                          + '<a class="popup-modal-dismiss" href="#"><div class="aceptarBTN" style="left:150px;"> </div></a>'
                                                          + '</div>'
                                                },
                                                type: 'inline',
                                                preloader: true,
                                                modal: true
                                            });

                                            $j(document).on('click', '.popup-modal-dismiss', function (e) {
                                                e.preventDefault();
                                                $j.magnificPopup.close();
                                            });

                                      $dp('#id_fechaTermino').datepicker('setStartDate', startDate);
                                      $dp('#id_fechaTermino').setDate(startDate);
                                  }
                                  else
                                  {
                                         $dp('#id_fechaInicio').datepicker('setEndDate', endDate);
                                  }

                                  //Debe ser "en proceso" si tiene una fecha de inicio anterior a hoy; y una fecha de término posterior a hoy.
                                    if ((STDate < today) && (endDate > today) && $j('select#id_tipoObra').val()!='2' ) {
                                        $j('select#id_tipoObra').val('---------');
                                        $j.magnificPopup.open({
                                            items: {
                                                src: '<div id="test-modal" class="alertaVENTANA" style="top:0px; left: 450px;">'
                                                + '<div class="textoALERTA">'
                                                + 'El Status de la obra debe ser en PROCESO y el Avance mayor a 0'
                                                + '</div>'
                                                + '<a class="popup-modal-dismiss" href="#"><div class="aceptarBTN" style="left:150px;"> </div></a>'
                                                + '</div>'
                                            },
                                            type: 'inline',
                                            preloader: true,
                                            modal: true
                                        });

                                        $j(document).on('click', '.popup-modal-dismiss', function (e) {
                                            e.preventDefault();
                                            $j.magnificPopup.close();
                                        });
                                    }
                              }
                              else
                              {
                                 $dp('#id_fechaInicio').datepicker('setEndDate', endDate);
                              }
                                //Debe ser "concluida" si tiene una fecha de termino anterior a hoy.

                                    if ((endDate < today) && $j('select#id_tipoObra').val()!='3' ){
                                        $j('select#id_tipoObra').val('---------');
                                        $j.magnificPopup.open({
                                                items: {
                                                    src:  '<div id="test-modal" class="alertaVENTANA" style="top:0px; left: 450px;">'
                                                          + '<div class="textoALERTA">'
                                                          +  'El Status de la obra debe ser CONCLUIDA y el Avance igual a 100'
                                                          + '</div>'
                                                          + '<a class="popup-modal-dismiss" href="#"><div class="aceptarBTN" style="left:150px;"> </div></a>'
                                                          + '</div>'
                                                },
                                                type: 'inline',
                                                preloader: true,
                                                modal: true
                                            });

                                            $j(document).on('click', '.popup-modal-dismiss', function (e) {
                                                e.preventDefault();
                                                $j.magnificPopup.close();
                                            });
                                    }

                            }).on('clearDate', function (selected) {
                            $dp('#id_fechaInicio').datepicker('setEndDate', null);
                        });


                    </script>

                 <script src="{% static "assets/js/jquery.numeric.js"%}"></script>
                 <script src="{% static "assets/js/utilerias.js"%}"></script>
                    {% endblock %}

                    {# JavaScript for prepopulated fields #}
                 {% prepopulated_fields_js %}

            </div>
        </form>


{% endblock %}